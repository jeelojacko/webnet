# TODO - WebNet

- [x] Add TypeScript tooling (tsconfig, TSX entry) and migrate LSA engine/UI to TS modules
- [x] Update ESLint to parse TS/TSX and ensure lint/build pass
- [x] Split UI into smaller components (Layout, Report, InputPane) to reduce App.tsx size
- [x] Add CI + coverage for Vitest suite (matrix/angles/parser/engine fixtures added; GitHub Actions workflow + coverage script)
- [x] Add Prettier + lint-staged for consistent formatting; remove unused src/App.css
- [x] Improve UX: file upload/save for .dat, unit-scaled outputs, map/ellipse view, exclusion toggles (re-run)
- [x] Editable observation tables (inline edits to values/weights) and true computational unit conversion
- [x] Performance hardening: add conditioning guard and residual spike warnings; consider Web Worker offload (future)
- [x] Consolidate toolbar settings into a dropdown menu
- [x] Export adjustment results as text + refresh-to-last-run input
- [x] Standardized residuals (Qvv), redundancy numbers, chi-square test, per-type residual summaries
- [x] Point precision (σN/σE/σH, ellipse azimuth, 95% toggle) + relative precision between unknown points
- [x] Map/ellipse viewer interaction upgrades: wheel zoom, middle-button pan, middle-double-click reset-to-extents, zoom-aware symbol scaling
- [x] Map/ellipse viewer usability refinement: full-height viewport fill in map tab and larger zoom-adaptive station labels
- [x] Sync README/agents docs with current parser/engine/UI state
- [ ] Adjustment report parity roadmap (Star\*Net alignment):
  - [x] Implement weighted control constraints from coordinate/elevation std errors (not only fixed/free) so control uncertainty participates in the solve
  - [x] Wire and report normal-matrix conditioning diagnostics (condition estimate + warnings for weak geometry)
  - [x] Upgrade outlier handling from fixed sigma thresholds to formal local tests with decision limits and MDB
  - [x] Expand global model test output to include chi-square critical bounds and variance-factor acceptance interval
  - [x] Add source line traceability (`sourceLine`) from parser through residual/report/export tables
  - [x] Improve exported `.txt` report to be unit-correct, sorted by blunder likelihood, and include suspect ranking
  - [x] Extend GNSS weighting from simplified isotropic XY to richer component/covariance models
  - [x] Resolve fixity/free-marker semantics mismatch (`*` meaning) between docs/parser/TODO and standard Star\*Net expectations
- [ ] Star\*Net format compatibility (Section 5.6):
  - [x] Elevation-only parsing (E records) with std errors/fixity and unit conversion
  - [~] Implement global inline options: .UNITS, .COORD 2D/3D, .ORDER NE/EN, .2D/.3D, .DELTA ON/OFF, .MAPMODE, .LWEIGHT, .NORMALIZE, .END (parses/logs complete; .LWEIGHT applied to leveling weights; header exposes coord/order/delta/map/normalize/.LWEIGHT/lon-sign defaults; remaining wiring pending per code type)
  - [x] Coordinate/position/elevation records: C (2D/3D with per-component std errs and !/\* fixity, NE/EN order), P geodetic positions (lat/long [+H], std errs mapped to NE, longitude sign), E elevation-only, ellipsoid variants CH/PH/EH (parsed; P/PH projected to local EN via first P origin; ellipsoid height flagged)
  - [x] Single obs: A angles (At-From-To or From-At-To), D distances (2D HD; 3D slope/HD per mode with HI/HT), V vertical (zenith or dH per mode with HI/HT), B bearings/azimuths (solved)
  - [x] Multiple obs: M (angle+dist+vertical with std err rules, HI/HT), BM (bearing/az+dist+vertical), DV (dist+vertical) with std errs and HI/HT (delta-mode emits dH; slope-mode emits zenith; face-2 weighting applied; defaults for stds/HI/HT captured)
  - [x] Traverse: TB (backsight station or bearing/az; dummy backsight handling), T legs (angle+dist+vertical with std err rules, HI/HT), TE closing angle to station or bearing/az with optional std err (basic conversion to angle/dist/vert added; mixed-face rejection when .NORMALIZE OFF; closure residuals/misclosure vectors logged)
  - [x] Direction sets: DB begin, DN directions, DM directions+measurements, DE end; face-1/face-2 handling, reject mixed-face when .NORMALIZE OFF (basic conversion to angle/dist/vert added; face-1/face-2 fixture added; face-2 weighting tweak)
  - [x] Direction sets: solve raw circle readings with per-set orientation parameters (for unreduced circle readings)
  - [x] A records auto-classify as DIR (azimuth) vs turned angle using initial coords; DIR uses closest residual with optional 180° flip
  - [x] Sideshots: SS diverted from adjustment, compute post-adjust, disallow occupy/backsight, optional name checking (basic parse to dist + vert/zenith; excluded from adjustment; occupy/backsight validation added; cannot target fixed control)
  - Leveling: L dH with distance or turns, std err or per-unit via .LWEIGHT (fallback applied; ft lengths converted to km), allow fixity/free
  - [~] Fixity/weights: support ! fixed per component, legacy \* fixed, numeric std errs per obs/component (free markers not implemented)
  - [x] Instrument library: EDM const/ppm, HZ/VA precision, instrument/target centering; .I to set current instrument
  - [x] Std error tokens (&/!/\*/numeric) for observations; .EDM additive/propagated; .CENTERING on/off; .ADDC add-centering mode
  - [x] Debug logging toggle (.DEBUG) to dump per-observation calc/residual/sigma by iteration
  - [x] Auto-drop height unknowns for stations with no vertical-sensitive observations (prevents 3D singularity)
  - Units/normalization: honor .UNITS for ft/m parsing/HI/HT, convert angles/bearings; normalize engine to meters/radians
  - Validation/logging: strict line validation, mode/order scope, HI/HT parsing, counts per type, logs for defaults/skips/flags
  - [x] Validation/logging: basic network diagnostics for under-observed stations
  - [x] Validation/logging: per-direction-set residual summaries in processing log
  - [x] Validation/logging: per-direction-set prefit summaries (using initial coords)
  - Inline modes & obs metadata: track delta mode/map mode/lon sign; capture HI/HT on distances; projection currently equirectangular (improve later)
  - Engine: map codes to internal types, apply HI/HT/dH/slope-HD, include bearings/azimuths, leveling weights, preserve obs IDs
  - [x] Engine: honor 2D solve mode (drop height parameters; skip lev/zenith in 2D)
  - Fixtures/tests: add Star\*Net-style fixtures for 2D/3D, TS+GPS+Leveling, traverses, direction sets, sideshots; Vitest cases for parsing/mode toggles and solves (bearing/zenith added)
  - Docs/UI: [x] Created `docs/USER_GUIDE.md` and `public/examples/star_net_demo.dat`; list supported Star\*Net codes/options, UI hints, surface parser errors with line numbers

- [ ] Total Station parity roadmap:
  - [x] Phase 1: add TS parity harness baseline fixture + tests for stable TS-only outputs
  - [x] Phase 1: add safer A-record interpretation with explicit `.AMODE` controls (AUTO/ANGLE/DIR)
  - [x] Phase 2: full face-set reduction workflow (face1/face2 set means, reduced set sigmas, raw-vs-reduced diagnostics)
  - [x] Phase 2: strengthen traverse/setup diagnostics (closure ratios, per-setup orientation quality, setup summaries)
  - [x] Phase 3: expand TS reduction options (.MAPMODE detail, curvature/refraction controls, vertical reduction options)
  - [x] Phase 3: post-adjusted sideshot coordinate/precision reporting section
  - [x] Phase 4: sideshot explicit azimuth support (`SS ... AZ=...`) so post-adjust SS coordinates can be computed without target approximations
  - [x] Phase 5: setup-based sideshot orientation (`SS ... HZ=/HA=/ANG=`) tied to current backsight, with propagated azimuth uncertainty
  - [x] Phase 6: add TS example pack (one realistic `.dat` per TS observation family + one all-in-one combined file in `public/examples`)
  - [x] Phase 7: add setup-level suspect diagnostics (`RMS|t|`, `Max|t|`, local-test fail counts, worst obs + source line) with ranked setup suspect tables in report/export
  - [x] Phase 8: add direction-target repeatability diagnostics (per-target raw spread, face balance, local-test/MDB, ranked suspect score) with report/export tables
  - [x] Phase 9: add multi-set direction repeatability trends by occupy-target (cross-set range/RMS, face-balance counts, suspect ranking) in report/export
  - [x] Phase 10: add automated suspect impact analysis (what-if exclusion: dSEUW, dMax|t|, chi-square change, max unknown shift, score) with one-click exclude+rerun
  - [x] Phase 11: add hover-tooltips for report column headers, key summary statistics (SEUW, chi-square), and all settings controls to improve interpretation
  - [x] Phase 12: add TS angular correlated stochastic model (`.TSCORR` on/off, scope, rho), apply correlated weights in solve/Qvv, and report/export correlation diagnostics
  - [x] Phase 13: add robust adjustment mode (`.ROBUST HUBER k`) with iterative downweight diagnostics and robust-vs-classical top-suspect comparison in report/export
  - [x] Phase 14: expand traverse closure diagnostics with linear ppm + angular/vertical misclosure checks, threshold pass/warn flags, per-loop severity ranking, and traverse suspect tables in report/export
  - [x] Phase 15: expand direction reduction diagnostics (raw max residual, face-pair delta, per-face spreads), and add structured direction reject diagnostics (line/set/record/expected-vs-actual face) in report/export
  - [x] Phase 16: add residual-quality diagnostics summary (|t| bins, local-test fail totals, redundancy weakness counts, worst-observation trace, and by-type screening table) in report/export
  - [x] Phase 17: improve 2D triangulation/trilateration compatibility by parsing 2D `M` lines with angle/dist sigma tokens (no forced vertical token) and auto-creating missing non-sideshot stations referenced in observations
